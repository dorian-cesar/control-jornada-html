<div id="pageHistorialActividades">
    <div style="text-align: center;">
        <h1>Historial de Actividades</h1>
    </div>
    <div class="redir margin-left: 30px ">
        <i class="fa fa-arrow-circle-left" onclick="panelControl()"> Atras </i>
    </div>
    <div class="panelCentralTable">
        <div>
            <button onclick="exportarCSVHAct()" class="btnsub">csv</button>
            <button onclick="excelHAct()" class="btnsub">Excel</button>
            <button onclick="imprimirTablaHAct()" class="btnsub">Imprimir</button>
            <button onclick="copiarHAct()" class="btnsub">Copiar</button>
        </div>
        <table id="tableHistorialAct" style="width: 1280px;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Conductor</th>
                    <th>Patente</th>
                    <th>Empresa</th>
                    <th>Tipo evento</th>
                    <th>Fecha y Hora</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script>
        //poblar tabla
        $(document).ready(function () {
            const api = getApi();
            const baseUrl = api.baseUrl;
            tableHistAct = $("#tableHistorialAct").DataTable({
                "ajax": {
                    "url": baseUrl + "historial",
                    "dataSrc": "",
                    "beforeSend": function (xhr) {
                        var token = localStorage.getItem("token");
                        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                    }
                },
                "columns": [
                    { "data": "id" },
                    { "data": "driver.nombre" },
                    { "data": "driver.vehicle.patente" },
                    { "data": "driver.company.nombre" },
                    { "data": "event" },
                    { "data": "formatted_updated_at" },
                ],
                "language": {
                    //"url":"//cdn.datatables.net/plug-ins/2.0.3/i18n/es-CL.json"
                }
            })
        })



        function exportarCSVHAct() {
            var tabla = document.getElementById("tableHistorialAct");
            var csv = [];

            // Obtener las filas de la tabla
            var filas = tabla.rows;

            // Recorrer las filas
            for (var i = 0; i < filas.length; i++) {
                var fila = [];
                var celdas = filas[i].cells;

                // Recorrer las celdas de cada fila
                for (var j = 0; j < celdas.length; j++) {
                    fila.push(celdas[j].innerText);
                }

                // Agregar la fila al CSV
                csv.push(fila.join(','));
            }

            // Crear el contenido del archivo CSV
            var csvContenido = csv.join('\n');

            // Crear un enlace temporal para descargar el archivo CSV
            var enlaceTemporal = document.createElement('a');
            enlaceTemporal.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContenido);
            enlaceTemporal.target = '_blank';
            enlaceTemporal.download = 'tableHistorialAct.csv';

            // Simular un clic en el enlace temporal
            document.body.appendChild(enlaceTemporal);
            enlaceTemporal.click();
            document.body.removeChild(enlaceTemporal);
        }

        function excelHAct() {
            // Seleccionar la tabla
            var tabla = document.getElementById("tableHistorialAct");

            // Crear un objeto de hoja de cálculo de Excel
            var tablaExcel = '<table>';

            // Recorrer cada fila de la tabla
            for (var i = 0; i < tabla.rows.length; i++) {
                tablaExcel += '<tr>';
                // Recorrer cada celda de la fila
                for (var j = 0; j < tabla.rows[i].cells.length; j++) {
                    tablaExcel += '<td>' + tabla.rows[i].cells[j].innerText + '</td>';
                }
                tablaExcel += '</tr>';
            }

            tablaExcel += '</table>';

            // Crear un enlace temporal
            var enlaceTemporal = document.createElement('a');
            enlaceTemporal.href = 'data:application/vnd.ms-excel,' + encodeURIComponent(tablaExcel);
            enlaceTemporal.download = 'tableHistorialAct.xls';

            // Simular un clic en el enlace temporal
            document.body.appendChild(enlaceTemporal);
            enlaceTemporal.click();
            document.body.removeChild(enlaceTemporal);
        }

        async function imprimirTablaHAct() {
            // Selecciona el contenedor de la tabla
            let data = await api.get("/historial");
            // Crea un nuevo elemento de ventana de impresión y coloca la tabla dentro de él
            var ventanaImpresion = window.open('', '_blank');
            var TablaHist = document.createElement("table");
            TablaHist.style.width = "100%";
            TablaHist.style.textAlign = "center";
            TablaHist.style.border = "1px solid black"
            TablaHist.style.borderCollapse = "collapse";
            var trOutH = document.createElement("tr");
            var thIdH = document.createElement("th");
            var thCor = document.createElement("th");
            var thVel = document.createElement("th");
            var thNomCond = document.createElement("th");
            var thPat = document.createElement("th");
            var thNomEmp = document.createElement("th");
            var thEvento = document.createElement("th");
            var thFechaC = document.createElement("th");

            thIdH.textContent = "ID";
            thCor.textContent = "coordenadas";
            thVel.textContent = "Velocidad";
            thNomCond.textContent = "Conductor";
            thPat.textContent = "Patente";
            thNomEmp.textContent = "Empresa";
            thEvento.textContent = "Tipo evento";
            thFechaC.textContent = "Fecha y Hora";

            trOutH.appendChild(thIdH);
            trOutH.appendChild(thCor);
            trOutH.appendChild(thVel);
            trOutH.appendChild(thNomCond);
            trOutH.appendChild(thPat);
            trOutH.appendChild(thNomEmp);
            trOutH.appendChild(thEvento);
            trOutH.appendChild(thFechaC);

            TablaHist.appendChild(trOutH);

            data.data.forEach(element => {
                var trInH = document.createElement("tr");
                var tdIdH = document.createElement("td");
                var tdCor = document.createElement("td");
                var tdVel = document.createElement("td");
                var tdNomCond = document.createElement("td");
                var tdPat = document.createElement("td");
                var tdNomEmp = document.createElement("td");
                var tdEvento = document.createElement("td");
                var tdFechaC = document.createElement("td");

                tdIdH.textContent = element.id;
                tdCor.textContent = element.coordenadas;
                tdVel.textContent = element.velocidad;
                tdNomCond.textContent = element.driver ? element.driver.nombre : "";
                tdPat.textContent = element.driver && element.driver.vehicle ? element.driver.vehicle.patente : "";
                tdNomEmp.textContent = element.driver && element.driver.company ? element.driver.company.nombre : "";
                tdEvento.textContent = element.event ? element.event.evento : "";
                tdFechaC.textContent = element.created_at;

                trInH.appendChild(tdIdH);
                trInH.appendChild(tdCor);
                trInH.appendChild(tdVel);
                trInH.appendChild(tdNomCond);
                trInH.appendChild(tdPat);
                trInH.appendChild(tdNomEmp);
                trInH.appendChild(tdEvento);
                trInH.appendChild(tdFechaC);


                TablaHist.appendChild(trInH);
            });


            // Imprime la ventana de impresión
            ventanaImpresion.document.body.appendChild(TablaHist);
            ventanaImpresion.print();
            ventanaImpresion.close();

        }
        function copiarHAct() {
            var tabla = document.getElementById("tableHistorialAct");
            var seleccion = window.getSelection();
            var rango = document.createRange();
            rango.selectNodeContents(tabla);
            seleccion.removeAllRanges();
            seleccion.addRange(rango);
            document.execCommand("copy");
            seleccion.removeAllRanges();
        }

    </script>
</div>