<div id="pageVehiculos">
    <div style="text-align: center ;">
        <h1>Gestión de Vehiculos</h1>
    </div>
    <div class="redir margin-left: 30px ">
        <i class="fa fa-arrow-circle-left" onclick="panelControl()"> Atras </i>
    </div>
    <div class="panelCentralTable">
        <button class="btnCrear" onclick="modalCrearVehiculo()">Crear Vehiculo</button>
        <button class="btnCrear" onclick="modalCrearTipo()">Crear Tipo</button>
        <button class="btnCrear" onclick="sincronizar()">Sincronizar</button>

        <table id="tableVehiculo" style="width: 1280px;">
            <thead>
                <tr>
                    <th>ID Tracker </th>
                    <th>Patente</th>
                    <th>Conductor </th>
                    <th>Empresa</th>
                    <th>Tipo</th>
                    <th>Ultimo Estado</th>
                    <th>Ultima Conexion</th>
                    <th>IMEI</th>
                    <th class="no-sort">Acciones</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <!--Modal Crear:-->
    <div class="mdl-overlay" id="crearVehiculo-overlay" onclick="closeModal('crearVehiculo')"></div>
    <div class="mdl-content" id="crearVehiculo-modal">
        <h1 class="tituloModal">Crear Vehiculo</h1>
        <form onsubmit="" method="post" id="formCrearVehiculo">
            <div class="form-cont">
                <div class="form-group">
                    <i>Patente</i>
                    <input type="text" id="patente" name="patente" class="entrada" placeholder="xx.xx.NN">
                </div>
                <div class="form-group">
                    <i>Tipo</i>
                    <select type="text" id="tipo" name="tipo" class="entrada"></select>
                </div>
                <div>
                    <button class="btnCrear" name="btnSubmit"><i class="fa fa-floppy-o"></i> Guardar</button>
                </div>
            </div>
        </form>
    </div>

    <!--Modal Crear Tipo:-->
    <div class="mdl-overlay" id="crearTipo-overlay" onclick="closeModal('crearTipo')"></div>
    <div class="mdl-content" id="crearTipo-modal">
        <h1 class="tituloModal">Crear Tipo</h1>
        <form onsubmit="" method="post" id="formCrearTipo">
            <div class="form-cont">
                <div class="form-group">
                    <i>Tipo</i>
                    <input type="text" name="tipo" class="entrada" placeholder="xxxxxxxxxx">
                </div>
                <div>
                    <button class="btnCrear" name="btnSubmit"><i class="fa fa-floppy-o"></i> Guardar</button>
                </div>
            </div>
        </form>
    </div>



    <!-- Modal Editar-->
    <div class="mdl-overlay" id="editVe-overlay" onclick="closeModal('editVe')"></div>
    <div class="mdl-content" id="editVe-modal">
        <h1 class="tituloModal"><i class='fa fa-pencil'></i> Editar Vehiculo </h1>
        <form onsubmit="" method="post" id="formEditVe">
            <div class="form-cont">
                <input type="number" name="idIn" hidden />
                <div class="form-group">
                    <i>Patente</i>
                    <input type="text" name="patente" class="entrada" placeholder="xx.xx.xx">
                </div>
                <div class="form-group">
                    <i>Track ID</i>
                    <input type="text" name="track_id" class="entrada" placeholder="Track ID">
                </div>
                <div class="form-group">
                    <i>Tipo</i>
                    <select type="text" id="tipo" name="tipo" class="entrada"></select>
                </div>
                <div>
                    <div class="form-group">
                        <i>Empresa</i>
                        <select type="text" id="empresa" name="empresa" class="entrada"></select>
                    </div>
                    <div>
                        <button class="btnCrear" name="btnSubmit"><i class="fa fa-floppy-o"></i> Guardar</button>
                    </div>
                </div>
            </div>
        </form>
    </div>


</div>
<script>
    //modal para crear vehiculo
    async function modalCrearVehiculo() {
        const form = document.getElementById('formCrearVehiculo');
        form.tipo.innerHTML = '';  // Limpiar opciones previas
        let listVeT = await api.get("/tipovehiculos")
            .then(data => data.data)
            .catch(error => console.error(error));

        listVeT.forEach(element => {
            const optTip = document.createElement("option");
            optTip.value = element.id;
            optTip.textContent = element.tipo;
            form.tipo.appendChild(optTip);
        });

        openModal('crearVehiculo');
    }

    var tableVe;
    const formCV = document.getElementById("formCrearVehiculo");
    formCV.addEventListener("submit", (e) => {
        e.preventDefault();

        if (validarFormularioCrearVehiculo()) {
            api.post("/vehiculos", {
                patente: formCV.patente.value,
                vehicle_type_id: formCV.tipo.value,
                vehicle_state_id: 1,
            })
            .then(data => {
                closeModal("crearVehiculo");
                tableVe.ajax.reload(null, false);  // Recargar la tabla sin cambiar la página
            })
            .catch(error => {
                console.error(error);
                if (error.response) {
                    switch (error.response.status) {
                        case 422:
                            window.alert("Este tipo de vehiculo ya existe");
                            break;
                    }
                }
            });
        }
    });

    //modal para crear Tipo de vehiculo
    async function modalCrearTipo() {
        openModal('crearTipo');
    }

    const formTipo = document.getElementById('formCrearTipo');
    formTipo.addEventListener("submit", (e) => {
        e.preventDefault();
        if (validarCrearTipo()) {
            api.post("/tipovehiculos", {
                tipo: formTipo.tipo.value,
            })
            .then(data => {
                closeModal('crearTipo');
                tableVe.ajax.reload(null, false);  // Recargar la tabla sin cambiar la página
            })
            .catch(error => {
                console.error(error);
                if (error.response) {
                    switch (error.response.status) {
                        case 422:
                            window.alert("Este tipo de vehiculo ya existe");
                            break;
                    }
                }
            });
        }
    });

    //Modal para editar
    async function modalEditVe(idIn, patenteIn, trackIdIn) {
        const form = document.getElementById('formEditVe');
        form.tipo.innerHTML = '';  // Limpiar opciones previas
        form.empresa.innerHTML = '';  // Limpiar opciones previas

        let vehiculo = await api.get(`/vehiculos/${idIn}`)
            .then(data => data.data[0])
            .catch(error => console.error(error));
        
        let listTipVe = await api.get(`/tipovehiculos`)
            .then(data => data.data)
            .catch(error => console.error(error));

        form.idIn.value = idIn;
        form.patente.value = patenteIn;
        form.track_id.value = trackIdIn;

        listTipVe.forEach(element => {
            if (!element.vehicle) {
                const optTipo = document.createElement('option');
                optTipo.value = element.id;
                optTipo.textContent = element.tipo;
                form.tipo.appendChild(optTipo);
            }
        });

        let listVeE = await api.get("/empresas")
            .then(data => data.data)
            .catch(error => console.error(error));

        listVeE.forEach(element => {
            const optEmp = document.createElement('option');
            optEmp.value = element.id;
            optEmp.textContent = element.nombre;
            form.empresa.appendChild(optEmp);
        });

        openModal('editVe');
    }

    const formEditVe = document.getElementById('formEditVe');
    formEditVe.addEventListener("submit", (e) => {
        e.preventDefault();
        if (validarEditar()) {
            api.put(`/vehiculos/${formEditVe.idIn.value}`, {
                patente: formEditVe.patente.value,
                track_id: formEditVe.track_id.value,
                vehicle_type_id: formEditVe.tipo.value,
                company_id: formEditVe.empresa.value,
                vehicle_state_id: 1,
            })
            .then(data => {
                closeModal("editVe");
                tableVe.ajax.reload(null, false);  // Recargar la tabla sin cambiar la página
            })
            .catch(error => {
                console.error(error);
            });
        }
    });

    function validarFormularioCrearVehiculo() {
        var patente = formCV.patente.value;
        var tipo = formCV.tipo.value;
        var patenteRegex = /^[a-zA-Z]{4}\d{2}$/;

        if (!patenteRegex.test(patente)) {
            alert("Formato de patente inválido. Debe ser XXXXNN");
            return false;
        }

        if (patente === "" || tipo === "") {
            alert("Todos los campos son obligatorios");
            return false;
        }

        return true;
    }

    function validarCrearTipo() {
        var tipo = formTipo.tipo.value;

        if (tipo === "") {
            alert("campo obligatorio");
            return false;
        }

        return true;
    }

    function validarEditar() {
        var patente = formEditVe.patente.value;
        var tipo = formEditVe.tipo.value;
        var track_id = formEditVe.track_id.value;
        var patenteRegex = /^[a-zA-Z]{4}\d{2}$/;

        if (!patenteRegex.test(patente)) {
            alert("Formato de patente inválido. Debe ser XXXXNN");
            return false;
        }

        if (patente === "" || tipo === "" || track_id === "") {
            alert("Todos los campos son obligatorios");
            return false;
        }

        return true;
    }

    async function sincronizar() {
        try {
            return await api.get('/sync');
        } catch (error) {
            console.error('Error buscando vehiculos', error);
            throw error;
        }
    }

    function eliminarVehiculo(id, patente) {
        if (confirm(`¿Está seguro que desea eliminar el vehículo con patente ${patente}?`)) {
            var token = localStorage.getItem("token");
            $.ajax({
                url: `https://dev.wit.la/api/vehiculos/${id}`,
                type: 'DELETE',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                },
                success: function (result) {
                    alert('Vehículo eliminado exitosamente.');
                    tableVe.ajax.reload(null, false);  // Recargar la tabla sin cambiar la página
                },
                error: function (xhr, status, error) {
                    alert('Ocurrió un error al eliminar el vehículo: ' + error);
                }
            });
        }
    }
    $(document).ready(function () {
        const baseUrl = "https://control-jornada.wit.la/backend-control-jornada/public/api/";
        tableVe = $("#tableVehiculo").DataTable({
            "ajax": {
                "url": baseUrl+"vehiculos",
                "dataSrc": "",
                "beforeSend": function (xhr) {
                    var token = localStorage.getItem("token");
                    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
                }
            },
            "columns": [
                { "data": "track_id" },
                { "data": "patente" },
                { "data": "driver.nombre" },
                { "data": "company.nombre" },
                { "data": "vehicle_type.tipo" },
                {
                    "data": "latest_log.estado",
                    "render": function (data, type, row) {
                        return data !== null ? data : 'sin estado';
                    }
                },
                {
                    "data": "latest_log.conexion",
                    "render": function (data, type, row) {
                        return data !== null ? data : 'sin conexion';
                    }
                },
                { "data": "imei" },
                {
                    "data": "id",
                    "render": function (data, type, row) {
                        var botones = [
                            `<button class='fa fa-pencil btnAccion' onclick='modalEditVe(${row.id},"${row.patente}")'></button>`,
                            `<button class='fa fa-trash btnAccion' onclick='eliminarVehiculo(${row.id},"${row.patente}")'></button>`
                        ];
                        return botones.join('');
                    }
                }
            ],
            "language": {
                //"url": "//cdn.datatables.net/plug-ins/2.0.3/i18n/es-CL.json"
            }
        });
    });
</script>
